#!/usr/bin/env bash
#
# zellij-rename-tab - Rename current zellij tab
#
# Usage: zellij-rename-tab <title>
#
# Uses $ZELLIJ_PANE_ID from environment automatically.
# Requires zellij-tab-status plugin installed (auto-launches if needed).
# See: https://github.com/dapi/zellij-tab-status

set -euo pipefail

# Plugin location
PLUGIN_PATH="file:$HOME/.config/zellij/plugins/zellij-tab-status.wasm"

# Escape string for JSON (handles backslashes and quotes)
json_escape() {
    local str="$1"
    str="${str//\\/\\\\}"
    str="${str//\"/\\\"}"
    printf '%s' "$str"
}

show_help() {
    cat <<'EOF'
zellij-rename-tab - Rename current zellij tab

Usage:
  zellij-rename-tab <title>

Examples:
  zellij-rename-tab "ðŸ¤– Working"
  zellij-rename-tab "#123"
  zellij-rename-tab "Feature: auth"

Requirements:
  - Must be run inside a zellij session
  - Requires zellij-tab-status plugin installed (auto-launches if needed)
  - Uses $ZELLIJ_PANE_ID from environment automatically

Install plugin:
  git clone https://github.com/dapi/zellij-tab-status
  cd zellij-tab-status && make install
EOF
}

if [[ $# -lt 1 ]]; then
    show_help
    exit 0
fi

TITLE="$1"

# Exit early if not in zellij
if [[ -z "${ZELLIJ:-}" ]]; then
    echo "Warning: Not in zellij session, doing nothing" >&2
    exit 0
fi

# Check plugin is installed
wasm_path="$HOME/.config/zellij/plugins/zellij-tab-status.wasm"
if [[ ! -f "$wasm_path" ]]; then
    echo "Error: Plugin not installed at $wasm_path" >&2
    echo "Run: make install (from zellij-tab-status directory)" >&2
    exit 1
fi

if [[ -z "${ZELLIJ_PANE_ID:-}" ]]; then
    echo "Error: ZELLIJ_PANE_ID not set" >&2
    exit 1
fi

# Escape values for JSON
pane_escaped=$(json_escape "$ZELLIJ_PANE_ID")
title_escaped=$(json_escape "$TITLE")

# --plugin flag auto-launches the plugin if not already running
# Timeout prevents hanging if plugin is unresponsive
if ! timeout 3s zellij pipe --plugin "$PLUGIN_PATH" --name tab-status -- "{\"pane_id\": \"$pane_escaped\", \"action\": \"set_name\", \"name\": \"$title_escaped\"}" < /dev/null; then
    echo "Error: zellij pipe timeout or failed" >&2
    exit 1
fi
