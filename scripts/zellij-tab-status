#!/usr/bin/env bash
#
# zellij-tab-status - Manage status emoji in zellij tab name
#
# Usage:
#   zellij-tab-status ðŸ¤–           # Set status emoji
#   zellij-tab-status --clear      # Remove status emoji
#   zellij-tab-status --get        # Get current status emoji
#   zellij-tab-status --name       # Get base name (without status)
#   zellij-tab-status --set-name X # Set tab name, preserving status emoji
#   zellij-tab-status --version    # Get plugin version
#
# All operations are handled sequentially by the plugin - no client-side race conditions.
# The status is the first grapheme cluster followed by a space.
# "ðŸ¤– Working" -> status: ðŸ¤–, name: Working

set -euo pipefail

show_help() {
    cat <<'EOF'
zellij-tab-status - Manage status emoji in zellij tab name

Usage:
  zellij-tab-status <emoji>        Set status emoji
  zellij-tab-status --clear, -c    Remove status emoji
  zellij-tab-status --get, -g      Get current status emoji
  zellij-tab-status --name, -n     Get base name (without status)
  zellij-tab-status --set-name, -s Set tab name (preserving status emoji)
  zellij-tab-status --version, -v  Get installed plugin version
  zellij-tab-status --help, -h     Show this help

Examples:
  zellij-tab-status ðŸ¤–             # "Working" -> "ðŸ¤– Working"
  zellij-tab-status â³             # "ðŸ¤– Working" -> "â³ Working"
  zellij-tab-status --clear        # "ðŸ¤– Working" -> "Working"
  zellij-tab-status                # Output: ðŸ¤–
  zellij-tab-status --set-name Code  # "ðŸ¤– Working" -> "ðŸ¤– Code"
  zellij-tab-status -s Code        # "Working" -> "Code"

All operations are sequential (via plugin) - no client-side race conditions.

Requirements:
  - Must be run inside a zellij session
  - Requires zellij-tab-status plugin installed (auto-launches if needed)
  - Uses $ZELLIJ_PANE_ID from environment automatically
EOF
}

# Plugin location
PLUGIN_PATH="file:$HOME/.config/zellij/plugins/zellij-tab-status.wasm"

# Escape string for JSON (handles backslashes and quotes)
json_escape() {
    local str="$1"
    str="${str//\\/\\\\}"
    str="${str//\"/\\\"}"
    printf '%s' "$str"
}

# Send command to plugin via pipe
# Usage: send_to_plugin <action> [<field> <value>]
send_to_plugin() {
    local action="$1"
    local field="${2:-}"
    local value="${3:-}"

    if [[ -z "${ZELLIJ_PANE_ID:-}" ]]; then
        echo "Error: ZELLIJ_PANE_ID not set" >&2
        exit 1
    fi

    local pane_escaped action_escaped payload
    pane_escaped=$(json_escape "$ZELLIJ_PANE_ID")
    action_escaped=$(json_escape "$action")

    if [[ -n "$field" ]]; then
        local value_escaped
        value_escaped=$(json_escape "$value")
        payload="{\"pane_id\": \"$pane_escaped\", \"action\": \"$action_escaped\", \"$field\": \"$value_escaped\"}"
    else
        payload="{\"pane_id\": \"$pane_escaped\", \"action\": \"$action_escaped\"}"
    fi

    # --plugin flag auto-launches the plugin if not already running
    local exit_code=0
    timeout 3s zellij pipe --plugin "$PLUGIN_PATH" --name tab-status -- "$payload" < /dev/null || exit_code=$?
    if [[ $exit_code -eq 124 ]]; then
        : # Timeout during session teardown, non-critical
    elif [[ $exit_code -ne 0 ]]; then
        echo "Warning: pipe command failed (exit $exit_code)" >&2
    fi
}

# Send command to plugin and rename tab with the returned name.
# Plugin computes the full name (with status emoji), returns it via pipe output,
# then we do the actual rename via CLI (workaround for zellij 0.43.x rename_tab bug).
rename_via_plugin() {
    local new_name
    new_name=$(send_to_plugin "$@")
    if [[ -n "$new_name" ]]; then
        timeout 3s zellij action rename-tab "$new_name" 2>/dev/null || true
    fi
}

# Exit early if not in zellij
check_zellij() {
    if [[ -z "${ZELLIJ:-}" ]]; then
        echo "Warning: Not in zellij session" >&2
        exit 0
    fi

    # Check plugin is installed
    local wasm_path="$HOME/.config/zellij/plugins/zellij-tab-status.wasm"
    if [[ ! -f "$wasm_path" ]]; then
        echo "Error: Plugin not installed at $wasm_path" >&2
        echo "Run: make install (from zellij-tab-status directory)" >&2
        exit 1
    fi
}

# Main
case "${1:-}" in
    -h|--help|"")
        show_help
        exit 0
        ;;
    -c|--clear)
        check_zellij
        rename_via_plugin "clear_status"
        ;;
    -g|--get)
        check_zellij
        send_to_plugin "get_status"
        ;;
    -n|--name)
        check_zellij
        send_to_plugin "get_name"
        ;;
    -s|--set-name)
        if [[ -z "${2:-}" ]]; then
            echo "Error: --set-name requires a name argument" >&2
            exit 1
        fi
        check_zellij
        rename_via_plugin "set_name" "name" "$2"
        ;;
    -v|--version)
        # Extract version from installed wasm binary (no plugin query needed)
        PLUGIN_WASM="$HOME/.config/zellij/plugins/zellij-tab-status.wasm"
        if [[ -f "$PLUGIN_WASM" ]]; then
            version=$(grep -aoE 'Plugin loaded v[0-9]+\.[0-9]+\.[0-9]+' "$PLUGIN_WASM" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "${version:-unknown}"
        else
            echo "Plugin not installed" >&2
            exit 1
        fi
        ;;
    -*)
        echo "Unknown option: $1" >&2
        show_help
        exit 1
        ;;
    *)
        # Assume it's an emoji to set
        check_zellij
        rename_via_plugin "set_status" "emoji" "$1"
        ;;
esac
